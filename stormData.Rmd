---
title: "Storm Data"
author: "patmau"
date: "6/1/2020"
output: html_document
---

# Storm Data Analysis

## Synopsis

bla bla bla

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(reshape2)
library(ggplot2)
library(gridExtra)
```

## System info

```{r systemInfo}
sessionInfo()
```

## Download and process data

Download the file if necessary and load it into R:

```{r download, cache=TRUE}
dataFile <- "data/StormData.csv.bz2"
if (!file.exists(dataFile)) {
    url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
    download.file(url, dataFile, method = "curl")
    date()
}

data <- read.csv(dataFile, header = TRUE, stringsAsFactors = FALSE)
```

### Event types

The [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf) lists 48 permitted event types.
In the data file, however, we find no less than `r length(levels(factor(data$EVTYPE)))` event types.
The top five most occurring event types:
```{r eventTypes}
head(summary(factor(data$EVTYPE)), 5)
```
Clearly, "TSTM WIND" and "THUNDERSTORM WIND" refer to the same type of event.
We perform a coarse clean-up of event types:

```{r cleanEventTypes}
# everything to upper case
data$EVTYPE <- toupper(data$EVTYPE)

# TSTM -> THUNDERSTORM
data$EVTYPE <- gsub("TSTM", "THUNDERSTORM", data$EVTYPE)

# combine types containing a certain keyword into a single event type
keys <- c("HURRICANE", "TORNADO", "THUNDERSTORM WIND", "FLASH FLOOD", "BLIZZARD", "HEAVY RAIN", "HEAVY SNOW")
for (key in keys) {
    index <- grep(key, data$EVTYPE)
    data$EVTYPE[index] <- key
}

data$EVTYPE <- factor(data$EVTYPE)
```

The number of event types is now `r length(levels(data$EVTYPE))`, with the top five:
```{r eventTypes2}
head(summary(data$EVTYPE), 5)
```

A much more thorough cleaning-up of event types in the data would be needed, but is beyond the scope of this assignment.


### Financial damage

Financial damage results from damage to property and damage to crop.
It is represented in the dataset as a combination of a number ("`PROPDMG`") and a magnitude expressed as an alphabetical character (`PROPDMGEXP`).
According to the documentation, allowed characters include 'K', 'M', 'B', for 10^3, 10^6, and 10^9.
We find:
```{r damageExponents}
summary(factor(data$PROPDMGEXP))
summary(factor(data$CROPDMGEXP))
```
The vast majority of entries contains no exponent or a valid one, and only those will be considered in this analysis:

```{r processDamage}
# valid exponents
expName <- c("U", "K", "M", "B")
expValue <- c(1, 1E3, 1E6, 1E9)
names(expValue) <- expName

# replace empty exponents with "U" (Unit) 
data$PROPDMGEXP[data$PROPDMGEXP == ""] <- "U"
data$CROPDMGEXP[data$CROPDMGEXP == ""] <- "U"

# extract entries with valid exponents
validExp <- data$PROPDMGEXP %in% expName & data$CROPDMGEXP %in%expName
damageData <- data[validExp, ]

# combine property and crop damage
damageData$totalDamage <- damageData$PROPDMG * expValue[damageData$PROPDMGEXP] +
    damageData$CROPDMG * expValue[damageData$CROPDMGEXP]
```

The single event with the largest total damage:
```{r maxDamage}
maxEvent <- which.max(damageData$totalDamage)
damageData[maxEvent, ]
```
A total damage of more than 100 Billion USD seems excessive for this event. It is more than three times the damage attributed to storm surge in Louisiana during Hurricane Katrina (this event ranks 2nd).
For the Napa Valley flooding event, we will set the total damage to 100M USD, which seems a more reasonable value (the `REMARKS` entry for this event mentions a damage of at least 70M).
```{r napaDamage}
damageData$totalDamage[maxEvent] <- 100E6
```


## Results

### Financial damage

```{r damage}
damage <- select(damageData, EVTYPE, totalDamage) %>%
    group_by(EVTYPE) %>%
    summarise(total = sum(totalDamage), count = n(), mean = mean(totalDamage)) %>%
    arrange(desc(total))

top5 <- head(damage, 6)

ggplot(data = top5,
       aes(x = reorder(EVTYPE, -total),
           y = total * 1E-9,
           fill = log10(count))) +
    geom_col() +
    labs(title = "Total Damage 1950 - 2011 by Event Type",
         x = "",
         y = "Billion USD",
         fill = "Nr. of events\n(log scale)")

```


### Casualties

```{r peopleDamage}
casualties <- select(data, EVTYPE, FATALITIES, INJURIES) %>%
    group_by(EVTYPE) %>%
    summarise(injured = sum(INJURIES),
              fatal = sum(FATALITIES)) %>%
    arrange(desc(injured + fatal))

top5 <- head(casualties, 5)
melted <- melt(top5, id.vars = "EVTYPE")

#line breaks for x-axis labels
melted$EVTYPE <- gsub(" ", "\n", melted$EVTYPE)

fullplot <- ggplot(data = melted,
       aes(x = reorder(EVTYPE, -value),
           y = value,
           fill = variable)
       ) +
    labs(title = "Total Number of Casualties 1950 - 2011",
         x = "",
         y = "Casualties") +
    theme(legend.title = element_blank()) + 
    geom_bar(position = "stack", stat = "identity") +
    scale_fill_manual(values = c("red", "black"))

zoomplot <- fullplot +
    coord_cartesian(ylim = c(0, 12000)) +
    labs(title = "Zoomed View")

grid.arrange(fullplot, zoomplot, nrow = 2)

```
